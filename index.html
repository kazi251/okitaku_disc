<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>TRPG ツール</title>
</head>
<body>
  <h2>🎤 セリフ送信</h2>
  <input type="text" id="name-input" placeholder="名前（例：KP太郎）">
  <input type="text" id="say-input" placeholder="セリフを入力">
  <button onclick="sendSay()">送信</button>

  <h2>🎲 チャットパレット（保存・検索・実行）</h2>
  <textarea id="chat-palette" rows="10" cols="60" placeholder="ここにコマンドを貼り付けて保存してください"></textarea>
  <br>
  <input type="text" id="search-input" placeholder="キーワードで検索（例：目星）">
  <button onclick="searchCommand()">検索</button>
  <br>
  <select id="command-list"></select>
  <button onclick="rollSelectedCommand()">このコマンドで振る</button>
  <div id="dice-result">🎲 ダイス結果がここに表示されます</div>

  <script>
    const sayWorkerUrl = "https://sayworker.kai-chan-tsuru.workers.dev/";
    const rollWorkerUrl = "https://rollworker.kai-chan-tsuru.workers.dev/";

    function sendSay() {
      const name = document.getElementById("name-input").value;
      const text = document.getElementById("say-input").value;

      fetch(sayWorkerUrl, {
        method: "POST",
        body: JSON.stringify({ name, text }),
      }).then(() => {
        document.getElementById("say-input").value = "";
      });
    }

    function searchCommand() {
      const query = document.getElementById("search-input").value.toLowerCase();
      const palette = document.getElementById("chat-palette").value.split("\n");
      const list = document.getElementById("command-list");
      list.innerHTML = "";
      for (const line of palette) {
        if (line.toLowerCase().includes(query)) {
          const option = document.createElement("option");
          option.text = line;
          option.value = line;
          list.appendChild(option);
        }
      }
    }

    async function rollSelectedCommand() {
      const command = document.getElementById("command-list").value;
      const url = new URL(rollWorkerUrl);
      url.searchParams.append("command", command);

      const response = await fetch(url.toString());
      const result = await response.json();

      const name = document.getElementById("name-input").value;
      if (result.ok) {
        const message = `${name} のロール：${command} → ${result.text}`;
        await fetch(sayWorkerUrl, {
          method: "POST",
          body: JSON.stringify({ name, text: message }),
        });
        document.getElementById("dice-result").innerText = `🎲 ${result.text}`;
      } else {
        document.getElementById("dice-result").innerText = `⚠️ エラー: ${result.reason}`;
      }
    }
  </script>
</body>
</html>
