<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>クトゥルフTRPG ツール</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea, input { width: 100%; margin-bottom: 10px; padding: 8px; }
    #suggestions {
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      margin-top: -10px;
      margin-bottom: 10px;
      background: white;
      position: relative;
      z-index: 10;
    }
    #suggestions div {
      padding: 5px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #suggestions div:hover {
      background: #eef;
    }
  </style>
</head>
<body>

  <h2>セリフ送信（探索者 太郎）</h2>
  <input type="text" id="say-text" placeholder="セリフを入力">
  <button onclick="sendSay()">送信</button>

  <h2>ダイスコマンド実行</h2>
  <input type="text" id="dice-command" placeholder="例: CCB<=75" oninput="showSuggestions()">
  <div id="suggestions"></div>
  <button onclick="rollDice()">ダイス実行</button>
  <div id="dice-result">🎲 結果がここに表示されます</div>

  <h2>チャットパレット（貼り付けて保存）</h2>
  <textarea id="chat-palette" rows="10" placeholder="チャットパレットをここに貼り付けてください"></textarea>
  <button onclick="savePalette()">保存</button>

  <script>
    const diceWorkerUrl = "https://rollworker.kai-chan-tsuru.workers.dev/";
    const sayWorkerUrl = "https://sayworker.kai-chan-tsuru.workers.dev/";

    function sendSay() {
      const content = document.getElementById("say-text").value;
      if (!content) return alert("セリフを入力してください");
      fetch(sayWorkerUrl, {
        method: "POST",
        body: JSON.stringify({ content }),
      });
      document.getElementById("say-text").value = "";
    }

    async function rollDice() {
      const command = document.getElementById("dice-command").value;
      if (!command) return alert("ダイスコマンドを入力してください");
      const url = new URL(diceWorkerUrl);
      url.searchParams.set("command", command);
      url.searchParams.set("say", "true");

      try {
        const res = await fetch(url.toString());
        const data = await res.json();
        document.getElementById("dice-result").innerText = `🎲 結果: ${data.ok ? data.text : "エラー: " + data.reason}`;
      } catch (e) {
        document.getElementById("dice-result").innerText = "⚠️ 通信エラー";
      }
    }

    function savePalette() {
      const raw = document.getElementById("chat-palette").value;
      const lines = raw.split("\n").map(line => line.trim()).filter(line => line);
      localStorage.setItem("palette", JSON.stringify(lines));
      alert("保存しました！");
    }

    function showSuggestions() {
      const input = document.getElementById("dice-command").value.toLowerCase();
      const suggestions = document.getElementById("suggestions");
      suggestions.innerHTML = "";
      if (!input) return;

      const palette = JSON.parse(localStorage.getItem("palette") || "[]");
      const matches = palette.filter(line => line.toLowerCase().includes(input));
      matches.forEach(match => {
        const div = document.createElement("div");
        div.textContent = match;
        div.onclick = () => {
          document.getElementById("dice-command").value = match;
          suggestions.innerHTML = "";
        };
        suggestions.appendChild(div);
      });
    }
  </script>
</body>
</html>
