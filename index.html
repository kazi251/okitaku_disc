<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>TRPG ãƒ„ãƒ¼ãƒ«</title>
</head>
<body>
  <h2>ğŸ¤ ã‚»ãƒªãƒ•é€ä¿¡</h2>
  <input type="text" id="name-input" placeholder="åå‰ï¼ˆä¾‹ï¼šKPå¤ªéƒï¼‰">
  <input type="text" id="say-input" placeholder="ã‚»ãƒªãƒ•ã‚’å…¥åŠ›">
  <button onclick="sendSay()">é€ä¿¡</button>

  <h2>ğŸ² ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆä¿å­˜ãƒ»æ¤œç´¢ãƒ»å®Ÿè¡Œï¼‰</h2>
  <textarea id="chat-palette" rows="10" cols="60" placeholder="ã“ã“ã«ã‚³ãƒãƒ³ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ã—ã¦ãã ã•ã„"></textarea>
  <br>
  <input type="text" id="search-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ï¼ˆä¾‹ï¼šç›®æ˜Ÿï¼‰">
  <button onclick="searchCommand()">æ¤œç´¢</button>
  <br>
  <select id="command-list"></select>
  <button onclick="rollSelectedCommand()">ã“ã®ã‚³ãƒãƒ³ãƒ‰ã§æŒ¯ã‚‹</button>
  <div id="dice-result">ğŸ² ãƒ€ã‚¤ã‚¹çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>

  <script>
    const sayWorkerUrl = "https://sayworker.kai-chan-tsuru.workers.dev/";
    const rollWorkerUrl = "https://rollworker.kai-chan-tsuru.workers.dev/";

    function sendSay() {
      const name = document.getElementById("name-input").value;
      const text = document.getElementById("say-input").value;

      fetch(sayWorkerUrl, {
        method: "POST",
        body: JSON.stringify({ name, text }),
      }).then(() => {
        document.getElementById("say-input").value = "";
      });
    }

    function searchCommand() {
      const query = document.getElementById("search-input").value.toLowerCase();
      const palette = document.getElementById("chat-palette").value.split("\n");
      const list = document.getElementById("command-list");
      list.innerHTML = "";
      for (const line of palette) {
        if (line.toLowerCase().includes(query)) {
          const option = document.createElement("option");
          option.text = line;
          option.value = line;
          list.appendChild(option);
        }
      }
    }

    async function rollSelectedCommand() {
      const command = document.getElementById("command-list").value;
      const url = new URL(rollWorkerUrl);
      url.searchParams.append("command", command);

      const response = await fetch(url.toString());
      const result = await response.json();

      const name = document.getElementById("name-input").value;
      if (result.ok) {
        const message = `${name} ã®ãƒ­ãƒ¼ãƒ«ï¼š${command} â†’ ${result.text}`;
        await fetch(sayWorkerUrl, {
          method: "POST",
          body: JSON.stringify({ name, text: message }),
        });
        document.getElementById("dice-result").innerText = `ğŸ² ${result.text}`;
      } else {
        document.getElementById("dice-result").innerText = `âš ï¸ ã‚¨ãƒ©ãƒ¼: ${result.reason}`;
      }
    }
  </script>
</body>
</html>
